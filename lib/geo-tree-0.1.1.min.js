!function(a){if("object"==typeof exports)module.exports=a();else if("function"==typeof define&&define.amd)define(a);else{var b;"undefined"!=typeof window?b=window:"undefined"!=typeof global?b=global:"undefined"!=typeof self&&(b=self),b.GeoTree=a()}}(function(){return function a(b,c,d){function e(g,h){if(!c[g]){if(!b[g]){var i="function"==typeof require&&require;if(!h&&i)return i(g,!0);if(f)return f(g,!0);throw new Error("Cannot find module '"+g+"'")}var j=c[g]={exports:{}};b[g][0].call(j.exports,function(a){var c=b[g][1][a];return e(c?c:a)},j,j.exports,a,b,c,d)}return c[g].exports}for(var f="function"==typeof require&&require,g=0;g<d.length;g++)e(d[g]);return e}({1:[function(a,b){function c(a,b,c){for(var d=[{units:"m",ratio:1},{units:"km",ratio:1e3},{units:"yd",ratio:.9144},{units:"mi",ratio:1609.34}],e=0;e<d.length&&d[e].units!==c;e++);if(d.length===e)return b;var f=b*d[e].ratio/(6378137*Math.cos(Math.PI*a/180));return 180*f/Math.PI}function d(){this.tree=new e}var e=a("./red-black"),f=a("./z-curve");d.prototype.insert=function(a,b,c){var d,e,g;if("number"==typeof a)d=a,e=b,g=c;else{if("object"!=typeof a)return;if("number"==typeof a.length){for(var h=0;h<a.length;h++)this.insert(a[h]);return}d=a.lat,e=a.lng,g=a.data}var i=Math.round(1e5*(d+90)),j=Math.round(1e5*(e+180)),k=f.xy2d(i,j);this.tree.insert(k,{idx:k,lat:d,lng:e,data:g})},d.prototype.find=function(a,b,d){var e,g;e=0===arguments.length,void 0===b&&(b=a),"number"==typeof b&&(g=c(a.lat,b,d));var h,i,j,k,l=-1/0,m=1/0;e||(void 0===g?(h=Math.min(a.lat,b.lat),i=Math.max(a.lat,b.lat),j=Math.min(a.lng,b.lng),k=Math.max(a.lng,b.lng)):(h=Math.max(a.lat-g,-90),i=Math.min(a.lat+g,90),j=Math.max(a.lng-g,-180),k=Math.min(a.lng+g,180)),l=f.xy2d(Math.round(1e5*(h+90)),Math.round(1e5*(j+180))),m=f.xy2d(Math.round(1e5*(i+90)),Math.round(1e5*(k+180))));var n,o,p,q,r=this.tree.find(l,m),s=[];if(e)for(n=0;n<r.length;n++)s.push(r[n].data);else if(void 0===g)for(n=0;n<r.length;n++)o=r[n],p=o.lat,q=o.lng,p>=h&&i>=p&&q>=j&&k>=q&&s.push(o.data);else{var t=g*g;for(n=0;n<r.length;n++)o=r[n],p=a.lat-o.lat,q=a.lng-o.lng,t>=p*p+q*q&&s.push(o.data)}return s},d.prototype.forEach=function(a){a&&this.tree.forEach(function(b){a(b.data)})},d.prototype.dump=function(a){return this.tree.dump(a)},b.exports=d},{"./red-black":2,"./z-curve":3}],2:[function(a,b){function c(a,b,c){this.parent=a,this.key=b,this.values=[c],this.left=null,this.right=null,this.color=e}function d(){this.root=null}var e=0,f=1;c.prototype.getGrand=function(){return this.parent?this.parent.parent:null},c.prototype.getUncle=function(){var a=this.getGrand();return a?a.left===this.parent?a.right:a.left:null},c.prototype.dump=function(){return"[k:"+this.key+",c:"+(e===this.color?"R":"B")+",#:"+this.values.length+",l:"+(this.left?this.left.key:"NULL")+",r:"+(this.right?this.right.key:"NULL")+",p:"+(this.parent?this.parent.key:"NULL")+",v:"+JSON.stringify(this.values)+"]"},d.prototype.insert=function(a,b){if("number"==typeof a)this._insert(a,b);else if("object"==typeof a)if("number"==typeof a.length)for(var c,d=0;d<a.length;d++)c=a[d],this._insert(c.key,c.value);else this._insert(a.key,a.value)},d.prototype._insert=function(a,b){var d,g,h,i,j;if(this.root)for(g=this.root;;){if(g.key===a)return void g.values.push(b);if(a<g.key){if(!g.left){d=g.left=new c(g,a,b);break}g=g.left}else{if(!g.right){d=g.right=new c(g,a,b);break}g=g.right}}else d=this.root=new c(null,a,b);for(h=d.getGrand(),i=d.getUncle();;){if(!g){d.color=f;break}if(f===g.color)break;{if(!i||e!==i.color){d===g.right&&g===h.left?(h.left=d,d.parent=h,(g.right=d.left)&&(d.left.parent=g),d.left=g,g.parent=d,d=g,g=d.parent):d===g.left&&g===h.right&&(h.right=d,d.parent=h,(g.left=d.right)&&(d.right.parent=g),d.right=g,g.parent=d,d=g,g=d.parent),g.color=f,h.color=e,d===g.left?((h.left=g.right)&&(g.right.parent=h),g.right=h):((h.right=g.left)&&(g.left.parent=h),g.left=h),j=h.parent,j?h===j.left?j.left=g:j.right=g:(this.root=g,g.color=f),g.parent=j,h.parent=g;break}g.color=i.color=f,h.color=e,d=h,g=d.parent,h=d.getGrand(),i=d.getUncle()}}},d.prototype.find=function(a,b){if(!this.root)return[];void 0===b&&(b=a);for(var c,d=[],e=[this.root];e.length;)c=e.pop(),c.key>=a&&c.key<=b&&d.push(c.values),c.right&&c.key<b&&e.push(c.right),c.left&&c.key>a&&e.push(c.left);var f,g,h,i=[];for(f=0;f<d.length;f++)for(h=d[f],g=0;g<h.length;g++)i.push(h[g]);return i},d.prototype.forEach=function(a){function b(c){if(c){b(c.left);for(var d=c.values,e=c.key,f=0;f<d.length;f++)a(d[f],e);b(c.right)}}a&&b(this.root)},d.prototype.dump=function(a){function b(d,e){if(d){a?c+=d.dump():console.log((void 0!==e?e+"+ ":"")+d.dump());var f=void 0===e?"":e+"  ";b(d.left,f),b(d.right,f)}}var c="";return a||console.log("--- dump start ---"),b(this.root),a||console.log("--- dump end ---"),c},b.exports=d},{}],3:[function(a,b){b.exports={xy2d:function(a,b){for(var c=1,d=Math.max(a,b),e=0;d>=c;)c<<=1;for(c>>=1;c;)e*=2,a&c&&(e+=1),e*=2,b&c&&(e+=1),c>>=1;return e}}},{}]},{},[1])(1)});